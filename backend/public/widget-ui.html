<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AidraAI Widget</title>
  <link rel="stylesheet" href="/widget-ui.css">
</head>
<body>
  <div class="panel">
    <div class="topbar">
      <div class="title">Chat with AidraAI</div>
      <button class="icon-btn" id="closeBtn" aria-label="Close">âœ•</button>
    </div>

    <div class="content">
      <div class="hero">
        <div class="logo">ğŸ¥</div>
        <h2>Sveiki ğŸ‘‹</h2>
        <p>Kuom galime padÄ—ti?</p>
      </div>

      <div class="chat" id="chat">
        <div class="msg ai">Sveiki ğŸ‘‹ ParaÅ¡ykite trumpai, ko jums reikia (kaina, registracija, konsultacija ir t.t.).</div>
      </div>

      <div class="footer">
        <div class="row">
          <input class="input" id="msg" placeholder="Ä®raÅ¡ykite klausimÄ…..." />
          <button class="send" id="sendBtn">SiÅ³sti</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const clientId = params.get("clientId") || "demo";

    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const closeBtn = document.getElementById("closeBtn");

    closeBtn.addEventListener("click", () => {
      window.parent.postMessage("aidra-close", "*");
    });

    async function send(){
      const text = input.value.trim();
      if(!text) return;

      chat.insertAdjacentHTML("beforeend", `<div class="msg user">${escapeHtml(text)}</div>`);
      input.value = "";
      chat.scrollTop = chat.scrollHeight;

      sendBtn.disabled = true;

      try{
        const res = await fetch("https://aidra-ai.onrender.com/api/chat", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ message: text, clientId })
        });

        const data = await res.json();
        const reply = data?.reply || "Ä®vyko klaida. Bandykite dar kartÄ….";

        chat.insertAdjacentHTML("beforeend", `<div class="msg ai">${escapeHtml(reply)}</div>`);
        chat.scrollTop = chat.scrollHeight;
      }catch(e){
        chat.insertAdjacentHTML("beforeend", `<div class="msg ai">Ä®vyko klaida. Bandykite dar kartÄ….</div>`);
      }finally{
        sendBtn.disabled = false;
        input.focus();
      }
    }

    function escapeHtml(str){
      return str
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", (e) => {
      if(e.key === "Enter") send();
    });
  </script>
</body>
</html>
